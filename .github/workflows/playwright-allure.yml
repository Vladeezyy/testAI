name: Playwright Tests with Allure Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
      
    - name: Run Playwright tests
      run: npm test
      continue-on-error: true
      
    - name: Generate Allure Report with History
      if: always()
      run: |
        # Create timestamp for this run
        TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
        RUN_NUMBER="${{ github.run_number }}"
        
        # Generate report to temp location
        npm run report:allure:generate
        
        # Create new structure
        mkdir -p allure-reports/run-${RUN_NUMBER}-${TIMESTAMP}
        cp -r docs/* allure-reports/run-${RUN_NUMBER}-${TIMESTAMP}/
        
        # Remove old docs
        rm -rf docs
        
        # Create fresh docs directory
        mkdir -p docs/reports
        
        # Copy current report to docs root (for direct access)
        cp -r allure-reports/run-${RUN_NUMBER}-${TIMESTAMP}/* docs/
        
        # Copy all reports to docs/reports
        cp -r allure-reports/* docs/reports/
        
        # Keep only last 3 reports
        cd docs/reports
        ls -t | tail -n +4 | xargs -r rm -rf
        cd ../..
        
        # Don't overwrite the Allure index.html - instead create a redirect page
        # The main Allure report is already in docs/ with its own index.html
        
        # Create a landing page in a separate directory
        mkdir -p docs/landing
        cat > docs/landing/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>Test Reports</title>
          <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
          <meta http-equiv="Pragma" content="no-cache">
          <meta http-equiv="Expires" content="0">
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; background: #f8f9fa; }
            .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            h1 { color: #333; margin-bottom: 10px; }
            .subtitle { color: #666; margin-bottom: 30px; }
            .report-list { list-style: none; padding: 0; }
            .report-item { 
              margin: 15px 0; 
              padding: 20px; 
              background: #f5f5f5; 
              border-radius: 8px;
              transition: transform 0.2s;
            }
            .report-item:hover { transform: translateX(5px); }
            .report-item a { 
              color: #0066cc; 
              text-decoration: none; 
              font-size: 18px;
              font-weight: 500;
            }
            .report-item a:hover { text-decoration: underline; }
            .current { 
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
              color: white;
            }
            .current a { color: white; }
            .badge { 
              display: inline-block; 
              padding: 4px 8px; 
              border-radius: 4px; 
              font-size: 12px; 
              margin-left: 10px;
            }
            .badge-current { background: rgba(255,255,255,0.3); }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>ğŸ“Š Test Reports</h1>
            <p class="subtitle">Latest test execution reports (last 3 runs)</p>
            <ul class="report-list">
        EOF
        
        # Add current report first (points to main index.html at root)
        echo "<li class='report-item current'><a href='../index.html'>ğŸŸ¢ Latest Report (Run #${RUN_NUMBER})<span class='badge badge-current'>CURRENT</span></a><br><small style='color: rgba(255,255,255,0.8);'>Generated: ${TIMESTAMP}</small></li>" >> docs/landing/index.html
        
        # Add links to archived reports (if they exist)
        if [ -d "docs/reports" ] && [ "$(ls -A docs/reports 2>/dev/null)" ]; then
          cd docs/reports
          for dir in $(ls -t | head -n 2); do
            echo "<li class='report-item'><a href='../reports/$dir/index.html'>ğŸ“„ Archive: $dir</a></li>" >> ../landing/index.html
          done
          cd ../..
        fi
        
        cat >> docs/landing/index.html << 'EOF'
            </ul>
            <p style="text-align: center; color: #999; margin-top: 40px; font-size: 14px;">
              Last updated: <span id="timestamp"></span>
            </p>
            <script>
              document.getElementById('timestamp').textContent = new Date().toLocaleString();
            </script>
          </div>
        </body>
        </html>
        EOF
        
        touch docs/.nojekyll
        
        # Output deployment info
        echo "ğŸ“Š Report generated successfully"
        echo "ğŸ“ Files in docs/:"
        ls -lah docs/
      
    - name: Setup Pages
      if: always()
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      if: always()
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'docs'
        
    - name: Deploy to GitHub Pages
      if: always()
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Output deployment URL
      if: always()
      run: |
        echo "ğŸš€ Deployment complete!"
        echo "ğŸ“Š Report URL: https://vladeezyy.github.io/testAI/"
        echo "ğŸ”— Deployment ID: ${{ steps.deployment.outputs.page_url }}"
        
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          allure-results/
          test-results/
        retention-days: 30
