name: Playwright Tests with Allure Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
      
    - name: Run Playwright tests
      run: npm test
      continue-on-error: true
      
    - name: Download previous reports
      continue-on-error: true
      run: |
        # Try to download the gh-pages branch
        git fetch origin gh-pages:gh-pages || echo "No gh-pages branch yet"
        if git rev-parse --verify gh-pages >/dev/null 2>&1; then
          git checkout gh-pages -- reports/ 2>/dev/null || echo "No reports directory yet"
          git checkout main
        fi
      
    - name: Generate Allure Report with History
      if: always()
      run: |
        # Create timestamp for this run
        TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
        RUN_NUMBER="${{ github.run_number }}"
        
        # Generate current report
        npm run report:allure:generate
        
        # Create reports directory structure
        mkdir -p docs/reports
        
        # Move current report to timestamped folder
        mv docs docs/reports/run-${RUN_NUMBER}-${TIMESTAMP}
        
        # Recreate docs folder and copy reports
        mkdir -p docs
        cp -r docs/reports/run-${RUN_NUMBER}-${TIMESTAMP}/* docs/
        
        # Keep only last 3 reports
        cd docs/reports
        ls -t | tail -n +4 | xargs -r rm -rf
        cd ../..
        
        # Create index page linking to all reports
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>Test Reports</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            h1 { color: #333; }
            .report-list { list-style: none; padding: 0; }
            .report-item { 
              margin: 10px 0; 
              padding: 15px; 
              background: #f5f5f5; 
              border-radius: 5px;
            }
            .report-item a { 
              color: #0066cc; 
              text-decoration: none; 
              font-size: 18px;
            }
            .report-item a:hover { text-decoration: underline; }
            .current { background: #e8f4f8; border-left: 4px solid #0066cc; }
          </style>
        </head>
        <body>
          <h1>ðŸ“Š Test Reports</h1>
          <p>Latest test execution reports (last 3 runs)</p>
          <ul class="report-list">
        EOF
        
        # Add links to all reports (newest first)
        cd docs/reports
        for dir in $(ls -t); do
          if [ "$dir" = "run-${RUN_NUMBER}-${TIMESTAMP}" ]; then
            echo "<li class='report-item current'><a href='reports/$dir/index.html'>ðŸŸ¢ Latest: $dir</a></li>" >> ../index.html
          else
            echo "<li class='report-item'><a href='reports/$dir/index.html'>ðŸ“„ $dir</a></li>" >> ../index.html
          fi
        done
        cd ../..
        
        cat >> docs/index.html << 'EOF'
          </ul>
        </body>
        </html>
        EOF
        
        touch docs/.nojekyll
      
    - name: Setup Pages
      if: always()
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      if: always()
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'docs'
        
    - name: Deploy to GitHub Pages
      if: always()
      id: deployment
      uses: actions/deploy-pages@v4
        
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          allure-results/
          test-results/
        retention-days: 30
